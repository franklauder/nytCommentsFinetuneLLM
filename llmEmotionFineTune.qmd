---
title: "Fine Tuning LLM Emotion Predictions on New ork Times 2017 Comments"
format: html
---


# Introduction


# Data Inspection

```{python}

import torch


```

```{python}

import pandas as pd
import matplotlib as plt
import seaborn as sns
import numpy as np


```

```{python}



from transformers import pipeline


```


```{python}


from transformers import AutoModel, AutoTokenizer
from transformers import AutoModelForSequenceClassification
from transformers import Trainer, TrainingArguments
from transformers.pipelines.pt_utils import KeyDataset
from tqdm.auto import tqdm





```


```{python}

from transformers.pipelines.pt_utils import KeyDataset




```

```{python}

from tqdm.auto import tqdm



```




```{python}


torch.cuda.is_available()



```


```{python}



file_path = r'C:\Users\fvlau\OneDrive\Documents\nytCommentsFinetuneLLM\\nyt_comments17_with_sentiment.csv'


```


```{python}


nytComments17_sentiments=pd.read_csv(file_path)



```



```{python}



nytComments17_sentiments.info()



```


```{python}


print(nytComments17_sentiments.shape)



```


```{python}

print(nytComments17_sentiments["sentiment"].value_counts())


```

```{python}

print(nytComments17_sentiments["sentiment"].value_counts(normalize=True).round(2))


```




```{python}


print(nytComments17_sentiments["typeOfMaterial"].value_counts(normalize=True).round(2))


```

```{python}



print(nytComments17_sentiments["newDesk"].value_counts(normalize=True).round(2))



```


```{python}



crashes=sns.load_dataset("car_crashes")


```

```{python}



crashes.head()



```

```{python}



print(nytComments17_sentiments[["typeOfMaterial", "sentiment"]].value_counts(normalize=True))


```

```{python}


print(nytComments17_sentiments[["newDesk", "sentiment"]].value_counts(normalize=True))



```


```{python}


nytComments17_sentiments.groupby(['typeOfMaterial', 'sentiment'])['sentiment'].count()



```


```{python}




pd.crosstab(index=nytComments17_sentiments.newDesk, columns=nytComments17_sentiments.sentiment, normalize='index').round(2)



```

```{python}



(pd.crosstab(index=nytComments17_sentiments.newDesk, columns=nytComments17_sentiments.sentiment, normalize='index').round(2).style.background_gradient(cmap='Blues', axis=None))



```






# Model Fine Tuning

```{python}


#pipe = pipeline("text-classification", model="cardiffnlp/twitter-roberta-base")


```


## Pre-process


The pre-trained model we are using has sentiment labels as: 0=negaticve, 1=neutral, 2=positive.  Since our dataset is labeled negative, neutral, and positive, we will convert them to integer values corresponding to the pre-trained model.


### Labels

```{python}


nytComments17_sentiments2 = nytComments17_sentiments.copy()


```

```{python}



rename_map={
    "negative": 0,
    "neutral": 1,
    "positive": 2
}




```


```{python}

pd.set_option('future.no_silent_downcasting', True)


```

```{python}


nytComments17_sentiments2 ['sentiment'] = nytComments17_sentiments2 ['sentiment'].replace(rename_map)



```

```{python}




nytComments17_sentiments2['sentiment'].value_counts()


```

Our dataset's sentiment labels now match the pre-trained model. 


### Train Test Validation split

Our dataset will be split into training, validation, and testing sets.  Before we initiate the split we will shuffle our data. 



```{python}


nytComments17_shuffled=nytComments17_sentiments2.copy()


```

```{python}


nytComments17_shuffled=np.random.shuffle(nytComments17_sentiments2)

np.random.shuffle()



```

We will use 70% of the commenbts for the training set, 10% for the validation set, and the remaining %20 for the testing set. 

```{python}


train_text=nytComments17_sentiments2.iloc[:678759]['commentBody'].values

train_labels=nytComments17_sentiments2.iloc[:678759]['sentiment'].values

```

```{python}


val_text=nytComments17_sentiments2.iloc[678759:775724]['commentBody'].values
val_labels=nytComments17_sentiments2.iloc[678759:775724]['sentiment'].values


```

```{python}

test_text=nytComments17_sentiments2.iloc[775724:]['commentBody'].values
test_labels=nytComments17_sentiments2.iloc[775724:]['sentiment'].values



```






```{python}


pipe=pipeline("text-classification", model="cardiffnlp/twitter-roberta-base-sentiment-latest")


```


```{python}


tokenizer = AutoTokenizer.from_pretrained("cardiffnlp/twitter-roberta-base-sentiment-latest")
model = AutoModelForSequenceClassification.from_pretrained("cardiffnlp/twitter-roberta-base-sentiment-latest")



```









